name: Release - ç‰ˆæœ¬å‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'

# æ·»åŠ æƒé™é…ç½®ï¼Œå…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ„å»ºäº§ç‰©
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
  packages: read   # å…è®¸è¯»å–åŒ…

env:
  CARGO_TERM_COLOR: always

jobs:
  # å‘å¸ƒå‰æ£€æŸ¥
  pre-release-check:
    name: å‘å¸ƒå‰æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯æ ‡ç­¾æ ¼å¼
        run: |
          if [[ ! "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "âŒ æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®ï¼åº”è¯¥æ˜¯ v*.*.*"
            exit 1
          fi
          echo "âœ… æ ‡ç­¾æ ¼å¼æ­£ç¡®: ${{ github.ref_name }}"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: npm run lint

      - name: æ„å»ºæ£€æŸ¥
        run: npm run build

  # Tauri æ„å»ºå’Œå‘å¸ƒ
  build-tauri:
    name: æ„å»º Tauri åº”ç”¨
    needs: pre-release-check
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            arch: 'aarch64'
          - platform: 'macos-latest' 
            args: '--target x86_64-apple-darwin'
            arch: 'x86_64'
          - platform: 'ubuntu-22.04'
            args: ''
            arch: 'x86_64'
          - platform: 'windows-latest'
            args: ''
            arch: 'x86_64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci

      - name: æ„å»º Tauri åº”ç”¨
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'My Universe ${{ github.ref_name }}'
          releaseBody: |
            ğŸ‰ **My Universe ${{ github.ref_name }}** å‘å¸ƒï¼

            ## ğŸ“‹ æ›´æ–°å†…å®¹
            æŸ¥çœ‹ [æäº¤è®°å½•](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) äº†è§£è¯¦ç»†æ›´æ”¹ã€‚

            ## ğŸ“¦ ä¸‹è½½è¯´æ˜
            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š

            ### Windows
            - ğŸ”§ **`.exe`** - å¯æ‰§è¡Œæ–‡ä»¶

            ### macOS  
            - ğŸ’¾ **`.dmg`** - macOS ç£ç›˜é•œåƒ
            - ğŸ **Apple Silicon (M1/M2)** å’Œ **Intel** èŠ¯ç‰‡å‡æ”¯æŒ

            ### Linux
            - ğŸ“± **`.AppImage`** - ä¾¿æºç‰ˆï¼Œæ— éœ€å®‰è£…
            - ğŸ“¦ **`.deb`** - Debian/Ubuntu åŒ…ç®¡ç†å™¨å®‰è£…åŒ…

            ## ğŸš€ å®‰è£…æ­¥éª¤
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. æŒ‰ç…§ç³»ç»Ÿæç¤ºå®Œæˆå®‰è£…
            3. é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦å…è®¸æœªçŸ¥æ¥æºåº”ç”¨

            ## âš ï¸ æ³¨æ„äº‹é¡¹
            - **macOS**: å¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸åº”ç”¨è¿è¡Œ
            - **Windows**: å¦‚æœ SmartScreen é˜»æ­¢ï¼Œè¯·ç‚¹å‡»"æ›´å¤šä¿¡æ¯"ç„¶å"ä»è¦è¿è¡Œ"
            - **Linux**: 
              - `.AppImage` ä¸‹è½½åéœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ï¼š`chmod +x *.AppImage`
              - `.deb` åŒ…å¯ä»¥ä½¿ç”¨ `sudo dpkg -i *.deb` å®‰è£…

            ---
            â¤ï¸ æ„Ÿè°¢ä½¿ç”¨ My Universeï¼å¦‚æœ‰é—®é¢˜è¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)
          releaseDraft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          args: ${{ matrix.args }}

  # å‘å¸ƒå®Œæˆé€šçŸ¥
  post-release:
    name: å‘å¸ƒå®Œæˆ
    needs: build-tauri
    runs-on: ubuntu-latest
    steps:
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ ç‰ˆæœ¬ ${{ github.ref_name }} å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Releases"
          echo "ğŸ”— ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" 